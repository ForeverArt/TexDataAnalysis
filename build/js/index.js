const ipc=require("electron").ipcRenderer,remote=require("electron").remote;var app=angular.module("app",["ngMaterial","ui.router","ngAnimate"]),uuid=localStorage.uuid;app.config(function(e){e.defaults.transformRequest=function(e){var n=[];for(var o in e)n.push(encodeURIComponent(o)+"="+encodeURIComponent(e[o]));return n.join("&")},e.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded"}}),app.config(function(e){e.state("main",{url:"/:name",templateUrl:function(e){return console.log("$stateParams.name: "+e.name),"content/"+e.name+".html"}})}),app.controller("main_ctrl",function(e,n,o){function t(){n({method:"post",url:"http://www.heraldstudio.com/api/user",data:{uuid:uuid}}).success(function(e){localStorage.cardnum=e.content.cardnum})}o.path("home"),e.active_name="home",e.items=[{name_en:"home",name_zh:"主页"},{name_en:"huodong",name_zh:"活动"},{name_en:"gpa",name_zh:"绩点"},{name_en:"srtp",name_zh:"SRTP"},{name_en:"lecture",name_zh:"人文讲座"},{name_en:"card",name_zh:"一卡通余额"},{name_en:"library",name_zh:"图书馆"},{name_en:"jwc",name_zh:"教务处"},{name_en:"schoolbus",name_zh:"校车"},{name_en:"phylab",name_zh:"物理实验课程"},{name_en:"exam",name_zh:"考试安排"}],localStorage.cardnum||t(),e.change_item=function(n){e.active_name=e.items[n].name_en},e.close_click=function(){console.log("close main window"),ipc.send("closeMainWindow")},e.refresh_click=function(){console.log("refresh_click"),e.$broadcast("refresh")}}),app.controller("home_ctrl",function(e,n){function o(){if(localStorage.pe){var n=JSON.parse(localStorage.pe);if((new Date).getTime()<n.expires)return e.pe=n,console.log("没过期"),0}console.log("过期"),e.pe_loading=!0,c()}function t(){if(localStorage.nic){var n=JSON.parse(localStorage.nic);if((new Date).getTime()<n.expires)return e.nic=n.content,console.log("没过期"),0}console.log("过期"),e.nic_loading=!0,a()}function c(){n({method:"post",url:"http://www.heraldstudio.com/api/pe",data:{uuid:uuid}}).success(function(n){e.pe=n,e.pe_loading=!1,n.expires=(new Date).getTime()+36e5,localStorage.pe=JSON.stringify(n),console.log(n)}).error(function(e,n){console.log(n)})}function a(){n({method:"post",url:"http://www.heraldstudio.com/api/nic",data:{uuid:uuid}}).success(function(n){e.nic=n.content,e.nic_loading=!1,n.expires=(new Date).getTime()+36e5,localStorage.nic=JSON.stringify(n)}).error(function(e,n){console.log(n)})}o(),t(),e.$on("refresh",function(){console.log("refresh"),e.pe_loading=!0,e.nic_loading=!0,c(),a()})}),app.controller("huodong_ctrl",function(e,n,o){function t(){if(localStorage.huodong){var n=JSON.parse(localStorage.huodong);if((new Date).getTime()<n.expires)return e.content=n.content,console.log(e.content),console.log("没过期"),0}console.log("过期"),e.loading=!0,c()}function c(){n({method:"get",url:"http://www.heraldstudio.com/herald/api/v1/huodong/get"}).success(function(n){e.content=n.content;for(var t in n.content)a(n.content[t].pic_url)&&(n.content[t].pic_url="http://read.html5.qq.com/image?src=forum&q=5&r=0&imgflag=7&imageUrl="+n.content[t].pic_url);o(function(){e.loading=!1},100),n.expires=(new Date).getTime()+36e5,localStorage.huodong=JSON.stringify(n)})}function a(e){return e.match("http://mmbiz.qpic.cn")}t(),e.$on("refresh",function(){console.log("huodong  refresh"),e.loading=!0,c()}),e.open_url=function(e){remote.getGlobal("sharedObject").page_url=e,ipc.send("createPageWindow")}}),app.controller("phylab_ctrl",function(e,n){function o(){if(localStorage.phylab){var n=JSON.parse(localStorage.phylab);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/phylab",data:{uuid:uuid}}).success(function(n){e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+864e5,localStorage.phylab=JSON.stringify(n)})}o(),e.$on("refresh",function(){console.log("phylab  refresh"),e.loading=!0,t()})}),app.controller("jwc_ctrl",function(e,n){function o(){if(localStorage.jwc){var n=JSON.parse(localStorage.jwc);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/jwc",data:{uuid:uuid}}).success(function(n){e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+36e5,localStorage.jwc=JSON.stringify(n)})}o(),e.$on("refresh",function(){console.log("jwc  refresh"),e.loading=!0,t()}),e.open_url=function(e){remote.getGlobal("sharedObject").page_url=e,ipc.send("createPageWindow")}}),app.controller("srtp_ctrl",function(e,n){function o(){if(localStorage.srtp){var n=JSON.parse(localStorage.srtp);if((new Date).getTime()<n.expires)return e.content=n.content,e.main_info=n.main_info,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/srtp",data:{uuid:uuid}}).success(function(n){n.main_info=n.content.shift(),e.main_info=n.main_info,e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+864e5,localStorage.srtp=JSON.stringify(n)})}o(),e.$on("refresh",function(){console.log("srtp  refresh"),e.loading=!0,t()})}),app.controller("lecture_ctrl",function(e,n){function o(){if(localStorage.lecture){var n=JSON.parse(localStorage.lecture);if((new Date).getTime()<n.expires)return e.content=n.content.detial,console.log("没过期"),0}e.loading=!0,c()}function t(){if(localStorage.lecture_notice){var n=JSON.parse(localStorage.lecture_notice);if((new Date).getTime()<n.expires)return e.notice_content=n.content,console.log("没过期"),0}e.notice_loading=!0,a()}function c(){n({method:"post",url:"http://www.heraldstudio.com/api/lecture",data:{uuid:uuid}}).success(function(n){e.content=n.content.detial,e.loading=!1,n.expires=(new Date).getTime()+36e4,localStorage.lecture=JSON.stringify(n)})}function a(){n({method:"post",url:"http://www.heraldstudio.com/wechat2/lecture",data:{uuid:uuid}}).success(function(n){e.notice_content=n.content,e.notice_loading=!1,n.expires=(new Date).getTime()+36e4,localStorage.lecture_notice=JSON.stringify(n)})}o(),t(),e.$on("refresh",function(){console.log("lecture  refresh"),e.loading=!0,e.notice_loading=!0,c(),a()})}),app.controller("gpa_ctrl",function(e,n){function o(){if(localStorage.gpa){var n=JSON.parse(localStorage.gpa);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/gpa",data:{uuid:uuid}}).success(function(n){e.main_info=n.content.shift();var o,t={};for(var c in n.content)o=n.content[c].semester,t[o]||(t[o]=[]),t[o].push(n.content[c]);e.content=t,e.loading=!1;var a={content:t,main_info:e.main_info,expires:(new Date).getTime()+864e5};localStorage.gpa=JSON.stringify(a)})}o(),e.$on("refresh",function(){console.log("gpa  refresh"),e.loading=!0,t()})}),app.controller("card_ctrl",function(e,n){function o(){if(localStorage.card){var n=JSON.parse(localStorage.card);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/card",data:{uuid:uuid}}).success(function(n){e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+36e5,localStorage.card=JSON.stringify(n)})}o(),e.$on("refresh",function(){console.log("card  refresh"),e.loading=!0,t()})}),app.controller("schoolbus_ctrl",function(e,n){function o(){if(localStorage.schoolbus){var n=JSON.parse(localStorage.schoolbus);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/schoolbus",data:{uuid:uuid}}).success(function(n){e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+2592e6,localStorage.schoolbus=JSON.stringify(n)})}o(),e.$on("refresh",function(){console.log("schoolbus  refresh"),e.loading=!0,t()})}),app.controller("exam_ctrl",function(e,n){function o(){if(localStorage.exam){var n=JSON.parse(localStorage.exam);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/exam",data:{uuid:uuid}}).success(function(n){e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+2592e6,localStorage.exam=JSON.stringify(n)})}o(),e.$on("refresh",function(){console.log("exam  refresh"),e.loading=!0,t()})}),app.controller("library_ctrl",function(e,n){function o(){if(localStorage.library){var n=JSON.parse(localStorage.library);if((new Date).getTime()<n.expires)return e.content=n.content,console.log("没过期"),0}e.loading=!0,t()}function t(){n({method:"post",url:"http://www.heraldstudio.com/api/library",data:{uuid:uuid}}).success(function(n){e.content=n.content,e.loading=!1,n.expires=(new Date).getTime()+36e5,localStorage.library=JSON.stringify(n)})}function c(o){n({method:"post",url:"http://www.heraldstudio.com/api/search",data:{uuid:uuid,book:o}}).success(function(n){e.search_content=n.content,e.search_loading=!1})}e.input={},o(),e.$on("refresh",function(){console.log("library  refresh"),e.loading=!0,t()}),e.search_click=function(){e.search_loading=!0;var n=e.input.keyword;""!=n&&c(n)},e.key_down=function(n){13==n.keyCode&&e.search_click()}});